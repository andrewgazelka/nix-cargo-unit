meta:
  started: 2026-01-14T00:00:00Z
  iterations: 1

features:
  # Phase 1: Core Unit Graph Parsing (foundation)
  - id: 1
    description: "Add comprehensive unit graph types with all cargo fields (platform, links, doc, doctest, etc.)"
    depends_on: []
    relevant_files:
      - "@src/unit_graph.rs"
    status: done
    block_count: 0

  - id: 2
    description: "Add unit identity hash (pkg_id + features + profile + mode) for unique derivation keys"
    depends_on: [1]
    relevant_files:
      - "@src/unit_graph.rs"
    status: done
    block_count: 0

  - id: 3
    description: "Add rustc flag reconstruction from unit metadata (edition, crate-type, opt-level, features, externs)"
    depends_on: [1]
    relevant_files:
      - "@src/rustc_flags.rs"
      - "@src/lib.rs"
    status: done
    block_count: 0

  - id: 4
    description: "Add source file filtering using pkg_id to extract crate source directory"
    depends_on: [1]
    relevant_files:
      - "@src/source_filter.rs"
      - "@src/lib.rs"
    status: done
    block_count: 0

  # Phase 1b: Nix Generation
  - id: 5
    description: "Refactor Nix codegen to use structured derivation builder with proper escaping"
    depends_on: [2, 3]
    relevant_files:
      - "@src/nix_gen.rs"
      - "@src/lib.rs"
      - "@src/unit_graph.rs"
    status: done
    block_count: 0

  - id: 6
    description: "Add CA-derivation attributes (__contentAddressed, outputHashMode) to generated Nix"
    depends_on: [5]
    relevant_files:
      - "@src/nix_gen.rs"
    status: done
    block_count: 0

  - id: 7
    description: "Add extern crate dependency wiring with proper --extern flags and -L paths"
    depends_on: [5]
    relevant_files:
      - "@src/nix_gen.rs"
      - "@src/rustc_flags.rs"
    status: done
    block_count: 0

  # Phase 2: Build Script Support
  - id: 8
    description: "Add build script detection (mode=run-custom-build) and separate derivation generation"
    depends_on: [5]
    relevant_files:
      - "@src/build_script.rs"
      - "@src/nix_gen.rs"
      - "@src/lib.rs"
    status: done
    block_count: 0

  - id: 9
    description: "Add build script output parsing (cargo:rustc-cfg, cargo:rustc-link-lib, OUT_DIR)"
    depends_on: [8]
    relevant_files:
      - "@src/build_script.rs"
    status: done
    block_count: 0

  - id: 10
    description: "Wire build script outputs into dependent unit rustc invocations"
    depends_on: [9]
    relevant_files:
      - "@src/nix_gen.rs"
      - "@src/build_script.rs"
    status: done
    block_count: 0

  # Phase 2b: Proc Macros
  - id: 11
    description: "Add proc-macro detection and host toolchain compilation"
    depends_on: [5]
    relevant_files:
      - "@src/proc_macro.rs"
      - "@src/nix_gen.rs"
      - "@src/lib.rs"
    status: done
    block_count: 0

  # Phase 3: IFD Integration
  - id: 12
    description: "Add Nix library with IFD-based unit graph generation (runCommand + builtins.readFile)"
    depends_on: [6, 7]
    relevant_files:
      - "@nix/lib.nix"
      - "@flake.nix"
    status: in_progress
    block_count: 0

  - id: 13
    description: "Add fileset-based source filtering in Nix derivations (lib.fileset.toSource)"
    depends_on: [12]
    relevant_files:
      - "@nix/lib.nix"
    status: pending
    block_count: 0

  - id: 14
    description: "Add workspace support with multiple root units"
    depends_on: [12]
    relevant_files:
      - "@nix/lib.nix"
    status: pending
    block_count: 0

  # Phase 4: Dynamic Derivations
  - id: 15
    description: "Add dynamic derivation mode with __structuredAttrs and recursive nix-instantiate"
    depends_on: [12, 10, 11]
    relevant_files:
      - "@nix/dynamic.nix"
      - "@flake.nix"
    status: pending
    block_count: 0

  # Phase 4b: Testing and Validation
  - id: 16
    description: "Add integration test comparing output against cargo build -v rustc invocations"
    depends_on: [7]
    relevant_files:
      - "@tests/integration.rs"
      - "@Cargo.toml"
    status: pending
    block_count: 0

  - id: 17
    description: "Add example workspace with build.rs and proc-macro for end-to-end testing"
    depends_on: [10, 11]
    relevant_files:
      - "@examples/workspace/Cargo.toml"
      - "@examples/workspace/crates/core/src/lib.rs"
      - "@examples/workspace/crates/macros/src/lib.rs"
      - "@examples/workspace/crates/app/src/main.rs"
      - "@examples/workspace/crates/app/build.rs"
    status: pending
    block_count: 0

progress:
  done: 11
  blocked: 0
  total: 17
